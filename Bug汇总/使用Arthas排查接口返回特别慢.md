# 问题描述

每个APP都有用户协议，比如用户登录协议、用户注册协议。

今天公司的APP送审被驳回，原因之一是因为用户协议页面响应太慢，点击之后，需要6~9秒才能看到协议内容。

所以排查了一下。



# 用户协议实现逻辑

用户协议的内容，是在数据库保存的html富文本，根据协议id查询协议详情接口，接口返回后，把协议内容展示出来。

# 抓包

既然页面展示比较慢，那就看看接口多长时间响应。

经过抓包，发现当协议内容达到150kb时，响应时间明显变慢；协议内容在45kb时，响应时间很快。

# 加缓存

检查了一下，接口是有缓存的：当redis缓存中没有对应id的协议时，从数据库中查询，查询完放到缓存后，http接口返回给前端。

既然有缓存，那接口方面，其实没有什么优化措施了。



# 查日志

查日志发现：后端服务接口日志显示几十ms

![image-20220914174257631](images/image-20220914174257631.png)





![image-20220914172517838](images/image-20220914172517838.png)

如果接口返回数据量比较小，则响应时间就很快：

![image-20220914174021727](images/image-20220914174021727.png)



运维回复：



> ![image-20220914174215873](images/image-20220914174215873.png)
>
> 看下对应的后端服务



开发排查：

> 后端服务日志显示几十ms
>
> ![image-20220914174257631](images/image-20220914174257631.png)



运维在容器中，直接调用接口（不走nginx），发现容器中的接口返回时间确实是很长的：

![image-20220914174503839](images/image-20220914174503839.png)

此时，压力就到了开发这边了。



# 思考

> 为什么日志中打印此接口几十毫秒返回了，但是真正在curl调用时，响应时间却那么长呢？？





![image-20220914172502139](images/image-20220914172502139.png)



![image-20220914172434014](images/image-20220914172434014.png)



![image-20220914172453917](images/image-20220914172453917.png)